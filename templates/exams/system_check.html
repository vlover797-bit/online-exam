{% extends 'base.html' %}

{% block content %}
<div class="system-check-container" style="max-width: 1000px; margin: 0 auto; padding: 20px;">
    <h2>System Check & Mobile Setup</h2>
    <p>Before starting the exam, please ensure your laptop camera is working and connect your mobile camera.</p>

    <div class="row" style="display: flex; gap: 20px; flex-wrap: wrap;">
        <!-- Laptop Camera -->
        <div class="card" style="flex: 1; min-width: 300px; background: #1f2937; padding: 20px; border-radius: 10px;">
            <h3>1. Laptop Camera Check</h3>
            <video id="laptop-video" width="100%" autoplay playsinline muted
                style="border: 2px solid cyan; border-radius: 5px;"></video>
            <p id="laptop-status" style="color: #4ade80; margin-top: 10px;">Checking camera...</p>
        </div>

        <!-- Mobile Connection -->
        <div class="card" style="flex: 1; min-width: 300px; background: #1f2937; padding: 20px; border-radius: 10px;">
            <h3>2. Connect Mobile Camera</h3>
            <p>Scan this QR code with your mobile device:</p>
            <div id="qrcode" style="background: white; padding: 10px; display: inline-block; border-radius: 5px;"></div>
            <p style="margin-top: 10px; font-size: 0.9rem;">
                OR visit: <a href="{{ mobile_url }}" target="_blank" style="color: cyan;">{{ mobile_url }}</a>
            </p>

            <h4 style="margin-top: 20px;">Mobile Feed Preview:</h4>
            <div
                style="width: 100%; height: 200px; background: #000; display: flex; align-items: center; justify-content: center; border: 2px dashed #555;">
                <img id="mobile-feed" style="max-width: 100%; max-height: 100%; display: none;" />
                <span id="mobile-placeholder" style="color: #888;">Waiting for connection...</span>
            </div>
        </div>
    </div>

    <!-- Start Exam Button -->
    <div style="margin-top: 30px; text-align: center;">
        <button id="btn-start-exam" class="btn-login"
            style="padding: 15px 40px; font-size: 1.2rem; opacity: 0.5; pointer-events: none;" onclick="startExam()">
            Start Exam
        </button>
        <p id="start-msg" style="margin-top: 10px; color: #ff4d4d;">Please complete both checks to proceed.</p>
    </div>
</div>

<!-- QR Code Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
    const attemptId = "{{ attempt.id }}";
    const examId = "{{ attempt.exam.id }}";
    const mobileUrl = "{{ mobile_url }}";

    const laptopVideo = document.getElementById('laptop-video');
    const laptopStatus = document.getElementById('laptop-status');
    const btnStart = document.getElementById('btn-start-exam');
    const startMsg = document.getElementById('start-msg');
    const mobileFeed = document.getElementById('mobile-feed');
    const mobilePlaceholder = document.getElementById('mobile-placeholder');

    let laptopOk = false;
    let mobileOk = false;

    // 1. Laptop Camera Setup
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            laptopVideo.srcObject = stream;
            laptopStatus.innerText = "Camera Active";
            laptopOk = true;
            checkStatus();
        })
        .catch(err => {
            laptopStatus.innerText = "Error: " + err.message;
            laptopStatus.style.color = "#ff4d4d";
        });

    // 2. Generate QR Code
    new QRCode(document.getElementById("qrcode"), {
        text: mobileUrl,
        width: 150,
        height: 150
    });

    // 3. Poll for Mobile Feed
    setInterval(() => {
        fetch(`/proctoring/get_mobile_frame/${attemptId}/`)
            .then(res => res.json())
            .then(data => {
                if (data.status === 'ok') {
                    mobileFeed.src = data.image;
                    mobileFeed.style.display = 'block';
                    mobilePlaceholder.style.display = 'none';
                    if (!mobileOk) {
                        mobileOk = true;
                        checkStatus();
                    }
                } else {
                    // blink or show offline
                    if (mobileOk) {
                        mobileOk = false; // Lost connection
                        checkStatus();
                    }
                }
            })
            .catch(err => console.error(err));
    }, 2000);

    function checkStatus() {
        if (laptopOk && mobileOk) {
            btnStart.style.opacity = "1";
            btnStart.style.pointerEvents = "all";
            startMsg.innerText = "All systems go. Good luck!";
            startMsg.style.color = "#4ade80";
        } else {
            btnStart.style.opacity = "0.5";
            btnStart.style.pointerEvents = "none";
            startMsg.innerText = "Please complete both checks to proceed.";
            startMsg.style.color = "#ff4d4d";
        }
    }

    function startExam() {
        window.location.href = `/exams/${examId}/take/`;
    }
</script>
{% endblock %}